#!/bin/bash

# --- CONFIGURATION ---
API_URL="http://localhost:8000"
if [ -z "$DONTFORGET_SECRET_KEY" ]; then
    echo -e "\033[0;31mError: DONTFORGET_SECRET_KEY is not set.\033[0m"
    exit 1
fi
API_KEY="$DONTFORGET_SECRET_KEY"

# --- COLORS ---
GREEN='\033[0;32m'
BLUE='\033[0;34m'
RED='\033[0;31m'
NC='\033[0m'

# --- LOGIC ---
COMMAND=$1
INPUT=$2

case $COMMAND in
    remember|save|r)
        if [ -z "$INPUT" ]; then
            TEMP_FILE=$(mktemp)
            ${EDITOR:-vim} "$TEMP_FILE"
            CONTENT=$(cat "$TEMP_FILE")
            rm "$TEMP_FILE"
            if [ -z "$CONTENT" ]; then echo -e "${RED}Aborted.${NC}"; exit 1; fi
        else
            CONTENT="$INPUT"
        fi
        
        echo -e "${BLUE}ðŸ§  Saving...${NC}"
        JSON_PAYLOAD=$(echo "$CONTENT" | python3 -c 'import json, sys; print(json.dumps({"text": sys.stdin.read().strip()}))')
        RESPONSE=$(curl -s -X POST "$API_URL/remember" -H "x-api-key: $API_KEY" -H "Content-Type: application/json" -d "$JSON_PAYLOAD")
        
        STATUS=$(echo $RESPONSE | python3 -c "import sys, json; print(json.load(sys.stdin).get('status', 'error'))" 2>/dev/null)
        if [ "$STATUS" == "saved" ]; then
            TAGS=$(echo $RESPONSE | python3 -c "import sys, json; print(json.load(sys.stdin).get('tags', ''))")
            echo -e "${GREEN}âœ” Saved!${NC} [Tags: $TAGS]"
        else
            echo -e "${RED}âœ˜ Error:${NC} $RESPONSE"
        fi
        ;;

    ask|remind|q)
        if [ -z "$INPUT" ]; then echo -e "${RED}Missing query.${NC}"; exit 1; fi
        echo -e "${BLUE}ðŸ” Thinking...${NC}"
        
        JSON_PAYLOAD=$(echo "$INPUT" | python3 -c 'import json, sys; print(json.dumps({"question": sys.stdin.read().strip()}))')
        RESPONSE=$(curl -s -X POST "$API_URL/remind" -H "x-api-key: $API_KEY" -H "Content-Type: application/json" -d "$JSON_PAYLOAD")
        ANSWER=$(echo $RESPONSE | python3 -c "import sys, json; print(json.load(sys.stdin).get('answer', 'Error'))" 2>/dev/null)
        echo -e "\n${GREEN}$ANSWER${NC}\n"
        ;;

    forget|delete|d)
        if [ -z "$INPUT" ]; then echo -e "${RED}Missing item to delete.${NC}"; exit 1; fi
        echo -e "${RED}ðŸ—‘ï¸  Processing deletion...${NC}"
        
        # We construct a natural language request for the Agent
        QUERY="Delete the memory about: $INPUT"
        JSON_PAYLOAD=$(echo "$QUERY" | python3 -c 'import json, sys; print(json.dumps({"question": sys.stdin.read().strip()}))')
        
        RESPONSE=$(curl -s -X POST "$API_URL/remind" -H "x-api-key: $API_KEY" -H "Content-Type: application/json" -d "$JSON_PAYLOAD")
        ANSWER=$(echo $RESPONSE | python3 -c "import sys, json; print(json.load(sys.stdin).get('answer', 'Error'))" 2>/dev/null)
        echo -e "\n${GREEN}$ANSWER${NC}\n"
        ;;
        
    *)
        echo "Usage: mem [r|q|d] [text]"
        exit 1
        ;;
esac
